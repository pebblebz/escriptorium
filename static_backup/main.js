(()=>{var e={9546:()=>{var e=Cookies.get("csrftoken");$.ajaxSetup({beforeSend:function(t,i){var n;n=i.type,/^(GET|HEAD|OPTIONS|TRACE)$/.test(n)||this.crossDomain||t.setRequestHeader("X-CSRFToken",e)}})}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,i),r.exports}(()=>{"use strict";i(9546);var e,t,n={};class s{constructor(e,t,i,s){this.id=e,this.count=1,this.message=t,this.level=i||"info",this.links=s;var r=$(".alert","#alert-tplt").clone();if(r.addClass("alert-"+this.level),$(".message",r).html(t),void 0!==this.links)for(let e=0;e<this.links.length;e++){let t=$("<div>").html('<a href="'+this.links[e].src+'" target="_blank">'+this.links[e].text+"</a>");this.links[e].cssClass&&$("a",t).addClass(this.links[e].cssClass),!1===this.links[e].targetBlank&&$("a",t).removeAttr("target"),$(".additional",r).append(t).css("display","block")}this.$element=r,this.htmlElement=this.$element.get(0),$("#alerts-container").append(r),r.show(),this.$element.on("closed.bs.alert",$.proxy((function(){delete n[this.id]}),this))}static add(e,t,i,r){var o=e||(new Date).getTime();return void 0===n[o]?n[o]=new s(o,t,i,r):n[o].incrementCounter(),n[o]}incrementCounter(){this.count++,$(".counter",this.$element).text("("+this.count+")").show()}}class r{constructor(e,{map:t=!1,mapScale:i=.2,mapColors:n=["grey","white"],mapMargin:s=10,mapDuration:r=2}){var o=document.createElement("div");o.classList.add("js-wheelzoom-container"),o.addEventListener("contextmenu",(function(e){e.preventDefault()})),e.parentNode.insertBefore(o,e),o.appendChild(e),o.style.position="relative",o.style.overflow="hidden",e.style.transformOrigin="0 0",e.style.transition="scale 0.3s",e.classList.add("js-zoom-target"),this.container=o,this.element=e,this.map=t,this.map&&(this.mapScale=i,this.mapDuration=r,this.mapTimer=null,this.mapMargin=s,this.makeMap(s,n),this.refreshMap())}update(e,t){this.element.style.transform="translate("+e.x+"px,"+e.y+"px) scale("+t+")"}showMap(e,t){if(this.map&&t>1){this.refreshMap(),this.mapWhole.style.opacity=.7,this.mapCurrent.textContent=Math.round(100*t)+"%",this.mapCurrent.style.transform="translate("+-e.x*this.mapScale/t+"px,"+-e.y*this.mapScale/t+"px) scale("+1/t+")",this.mapTimer&&clearInterval(this.mapTimer);let i=1e3*this.mapDuration/100,n=this.mapWhole.style.opacity/i;this.mapTimer=setInterval(function(){this.mapWhole.style.opacity<=0&&clearInterval(this.mapTimer),this.mapWhole.style.opacity=this.mapWhole.style.opacity-n}.bind(this),100)}}refreshMap(){if(this.map){let e=this.container.getBoundingClientRect();this.mapWhole.style.top=e.y+this.mapMargin+"px",this.mapWhole.style.left=e.x+this.mapMargin+"px",this.mapWhole.style.width=e.width*this.mapScale+"px",this.mapWhole.style.height=e.height*this.mapScale+"px"}}makeMap(e,t){this.mapWhole=document.createElement("div"),this.mapWhole.classList.add("wheelzoom-outter-map"),this.mapWhole.style.position="fixed",this.mapWhole.style.opacity=0,this.mapWhole.style.backgroundColor=t[0],this.mapWhole.style.pointerEvents="none",this.container.appendChild(this.mapWhole),this.mapCurrent=document.createElement("div"),this.mapCurrent.classList.add("wheelzoom-inner-map"),this.mapCurrent.style.position="absolute",this.mapCurrent.style.opacity=.5,this.mapCurrent.style.width="100%",this.mapCurrent.style.height="100%",this.mapCurrent.style.backgroundColor=t[1],this.mapCurrent.style.transformOrigin="0 0",this.mapWhole.appendChild(this.mapCurrent)}}var o,a,l=new class{constructor(){let e=window.localStorage.getItem("escriptorium.userProfile");this.settings=e?JSON.parse(e).settings:{}}saveProfile(){window.localStorage.setItem("escriptorium.userProfile",JSON.stringify({settings:this.settings}))}set(e,t){this.settings[e]=t,this.saveProfile()}get(e,t){return void 0!==this.settings[e]?this.settings[e]:t}delete(e){delete this.settings[e],this.saveProfile()}setUserId(e){this.userId=e}getCookieConsent(){this.get("cookie-consent")||Alert.add("cookie-consent","eScriptorium uses cookies to store the user session and local storage to save user interface preferences.","warning",[{src:"",text:"Accept",cssClass:"btn btn-outline-dark btn-sm mt-2",targetBlank:!1}]).htmlElement.querySelector(".additional a").addEventListener("click",function(e){return this.set("cookie-consent",!0),!1}.bind(this))}resetCookieConsent(){this.set("cookie-consent",!1)}};Dropzone.autoDiscover=!1;var c=null,d=null;function h(e){var t=u.getSelectedPks().length;if(!e.startsWith("import")&&t<1)return void alert("Select at least one image.");$("#selected-num","#"+e+"-wizard").text(t),1!=t?$("#id_bw_image").attr("disabled",!0):$("#id_bw_image").attr("disabled",!1),$(".process-part-form","#"+e+"-wizard").get(0).reset();let i=userProfile.get("initialTranscriptions");i&&i[o]&&($("#process-part-form-export #id_transcription").val(i[o]),$("#process-part-form-train #id_transcription").val(i[o]));let n=userProfile.get("exportFormat");n&&$("#process-part-form-export #id_file_format").val(n),$("#"+e+"-wizard").modal("show")}class u{constructor(e,t,i){this.pk=e.pk,this.order=e.order,this.name=e.name,this.title=e.title,this.typology=e.typology,this.image=e.image,this.filename=e.filename,this.image_file_size=e.image_file_size,this.bw_image=e.bw_image,this.workflow=e.workflow,this.task_ids={},this.progress=e.transcription_progress,this.locked=!1,this.avgConfidence=e.max_avg_confidence,this.api=a.part.replace("{part_pk}",this.pk);var n=$(".card","#card-template").clone();this.$element=n,this.domElement=this.$element.get(0),this.selectButton=$(".js-card-select-hdl",n),this.deleteButton=$(".js-card-delete",n),this.dropAfter=$(".js-drop","#card-template").clone(),n.attr("id",n.attr("id").replace("{pk}",this.pk)),this.updateThumbnail(),$("img.card-img-top",n).attr("title",this.title+" ("+this.image_file_size+" bytes)\n<"+this.filename+">"),n.attr("draggable",!0),$("img",n).attr("draggable",!1),$("img",n).attr("selectable",!1),$("input",this.$element).on("mouseover",$.proxy((function(e){this.$element.attr("draggable",!1)}),this)).on("mouseout",$.proxy((function(e){this.$element.attr("draggable",!0)}),this)),$("#cards-container").append(n),$("#cards-container").append(this.dropAfter),this.editButton=$(".js-edit",this.$element),this.cancelTasksButton=$(".js-cancel",this.$element),this.convertIcon=$(".js-compressing",this.$element),this.binarizedButton=$(".js-binarized",this.$element),this.segmentedButton=$(".js-segmented",this.$element),this.transcribeButton=$(".js-trans-progress",this.$element),this.alignButton=$(".js-align",this.$element),this.progressBar=$(".progress-bar",this.transcribeButton),this.progressBar.css("width",this.progress+"%"),this.progressBar.text(this.progress+"%"),this.updateWorkflowIcons();var s="/document/"+o+"/part/"+this.pk+"/edit/",r=this.progressBar;if(this.avgConfidence&&i){r.attr("title",`Confidence: ${(100*this.avgConfidence).toFixed(1)}%`);const e=120*Math.pow(this.avgConfidence,4);r.css("background-color",`hsl(${e}, 100%, 50%, 50%)`)}this.editButton.click((function(e){document.location.replace(s)})),this.cancelTasksButton.click($.proxy((function(e){["ongoing","pending"].includes(this.workflow.align)&&!window.confirm("This will stop ALL alignment tasks on this document. Are you sure you want to stop alignment?")||this.cancelTasks()}),this)),"False"!==t&&(this.binarizedButton.click($.proxy((function(e){this.select(),u.refreshSelectedCount(),h("binarize")}),this)),this.segmentedButton.click($.proxy((function(e){this.select(),u.refreshSelectedCount(),h("segment")}),this)),this.transcribeButton.click($.proxy((function(e){this.select(),u.refreshSelectedCount(),h("transcribe")}),this)),this.alignButton&&this.alignButton.click($.proxy((function(e){this.select(),u.refreshSelectedCount(),h("align")}),this))),this.index=$(".card","#cards-container").index(this.$element),n.data("partCard",this),addImageToLoader(n),this.defaultColor=this.$element.css("color"),this.selectButton.on("click",$.proxy((function(e){e.shiftKey?d&&u.getRange(d.index,this.index).each((function(e,t){$(t).data("partCard").select()})):this.toggleSelect(),u.refreshSelectedCount()}),this)),this.deleteButton.on("click",$.proxy((function(e){confirm("Do you really want to delete this image?")&&(this.delete(),u.refreshSelectedCount())}),this)),this.$element.on("dblclick",$.proxy((function(e){this.toggleSelect(),u.refreshSelectedCount()}),this)),this.$element.on("dragstart",$.proxy((function(e){this.locked||(e.originalEvent.dataTransfer.setData("text/card-id",e.target.id),c=e.target.id,$(".js-drop").addClass("drop-target"))}),this)),this.$element.on("dragend",$.proxy((function(e){$(".js-drop").removeClass("drop-target")}),this))}inQueue(){return("pending"==this.workflow.convert||"pending"==this.workflow.binarize||"pending"==this.workflow.segment||"pending"==this.workflow.transcribe||"pending"==this.workflow.align)&&!this.working()}working(){return"ongoing"==this.workflow.convert||"ongoing"==this.workflow.binarize||"ongoing"==this.workflow.segment||"ongoing"==this.workflow.transcribe||"ongoing"==this.workflow.align}isCancelable(){return[this.workflow.align,this.workflow.binarize,this.workflow.segment,this.workflow.transcribe].some((e=>["ongoing","pending"].includes(e)))}updateThumbnail(){let e,t=$("img.card-img-top",this.$element);e=this.image.thumbnails&&null!=this.image.thumbnails.card?this.image.thumbnails.card:this.image.uri,t.attr("src")&&t.attr("src",e),t.attr("data-src",e)}updateWorkflowIcons(){for(var e=[["convert",this.convertIcon],["binarize",this.binarizedButton],["segment",this.segmentedButton],["transcribe",this.transcribeButton],["align",this.alignButton]],t=0;t<e.length;t++){var i=e[t][0],n=e[t][1];n&&null==this.workflow[i]?(n.removeClass("pending").removeClass("ongoing").removeClass("error").removeClass("done"),n.attr("title",n.data("title"))):n&&(n.removeClass("pending").removeClass("ongoing").removeClass("error").removeClass("done"),n.addClass(this.workflow[i]),n.attr("title",n.data("title")+" ("+this.workflow[i]+")"))}this.inQueue()||this.working()?this.lock():this.unlock(),this.isCancelable()?this.cancelTasksButton.show():this.cancelTasksButton.hide()}remove(){this.dropAfter.remove(),this.$element.remove()}select(e=!0){this.locked||(d=this,this.$element.addClass("bg-dark"),this.$element.css({color:"white"}),$("i",this.selectButton).removeClass("fa-square"),$("i",this.selectButton).addClass("fa-check-square"),e&&this.$element.get(0).scrollIntoView(),this.selected=!0)}unselect(){d=null,this.$element.removeClass("bg-dark"),this.$element.css({color:this.defaultColor}),$("i",this.selectButton).removeClass("fa-check-square"),$("i",this.selectButton).addClass("fa-square"),this.selected=!1}toggleSelect(){this.selected?this.unselect():this.select()}lock(){this.locked=!0,this.$element.addClass("locked"),this.$element.attr("draggable",!1)}unlock(){this.locked=!1,this.$element.removeClass("locked"),this.$element.attr("draggable",!0)}moveTo(e,t){void 0===t&&(t=!0),this.previousIndex=this.index;var i=$("#cards-container .js-drop")[e];this.$element.insertAfter(i),this.dropAfter.insertAfter(this.$element),this.previousIndex<e&&e--,t&&$.post(this.api+"move/",{index:e}).done($.proxy((function(e){this.previousIndex=null}),this)).fail($.proxy((function(e){this.moveTo(this.previousIndex,!1),console.log("Something went wrong :(",e)}),this)).always($.proxy((function(){this.unlock()}),this)),this.index=e}cancelTasks(){$.post(this.api+"cancel/",{}).done($.proxy((function(e){e.workflow.align!==this.workflow.align?$("#cards-container .card").each((function(t,i){let n=$(i).data("partCard");"ongoing"===n.workflow.align&&(n.workflow=e.workflow,n.updateWorkflowIcons())})):(this.workflow=e.workflow,this.updateWorkflowIcons())}),this)).fail($.proxy((function(e){console.log("Couldn't cancel the task.")})))}delete(){$.ajax({url:this.api,type:"DELETE"}).done($.proxy((function(e){this.remove()}),this)).fail($.proxy((function(e){console.log("Couldn't delete part "+this.pk)}),this))}static fromPk(e){return $("#image-card-"+e).data("partCard")}static getRange(e,t){var i,n;return e<t?(i=e,n=t):(i=t,n=e),$("#cards-container .card").slice(i,n+1)}static getSelectedPks(){var e=[];return $("#cards-container .card").each((function(t,i){var n=$(i).data("partCard");n.selected&&e.push(n.pk)})),e}static refreshSelectedCount(){$("#selected-counter").text(u.getSelectedPks().length+"/"+$("#cards-container .card").length).parent().show()}}window.Alert=s,window.bootWebsocket=function(){let t="https:"===location.protocol?"wss:":"ws:";(e=new ReconnectingWebSocket(t+"//"+window.location.host+"/ws/notif/")).maxReconnectAttempts=3,e.addEventListener("open",(function(e){DEBUG&&console.log("Connected to notification socket")})),e.addEventListener("message",(function(e){var t=JSON.parse(e.data);if(DEBUG&&console.log("Received ws message: ",t),"message"==t.type){var i=t.text;s.add(t.id,i,t.level,t.links)}else"event"==t.type&&$("#alerts-container").trigger(t.name,t.data)})),e.addEventListener("close",(function(e){DEBUG&&console.error("Notification socket closed unexpectedly")}))},window.joinDocumentRoom=function(t){e.addEventListener("open",(function(i){e.send('{"type": "join-room", "object_cls": "document", "object_pk": '+t+" }")}))},window.bootHelp=function(){var e=userProfile.get("closedHelps")||[];document.querySelectorAll(".help-text .close").forEach((t=>t.addEventListener("click",(function(t){let i=t.target.closest("button").parentNode;i.parentNode,e||(e=[]),i.getAttribute("id")&&(e.push(i.getAttribute("id")),userProfile.set("closedHelps",e)),i.style.display="none"})))),document.querySelectorAll("button.help").forEach((t=>t.addEventListener("click",(function(t){let i=t.target.closest("button").parentNode,n=i.querySelector(".alert.help-text"),s=e.indexOf(i.getAttribute("id"));"none"==window.getComputedStyle(n).display?(-1!=s&&e.splice(s,1),i.querySelector(".alert.help-text").style.display="block"):(-1==s&&e.push(i.getAttribute("id")),i.querySelector(".alert.help-text").style.display="none"),userProfile.set("closedHelps",e)})))),e&&e.forEach((function(e,t){let i=document.querySelector(".help-text#"+e);i&&(i.style.display="none")}))},window.bootLazyload=function(){var e;if("IntersectionObserver"in window)e=document.querySelectorAll(".lazy"),t=new IntersectionObserver((function(e,i){e.forEach((function(e){if(e.isIntersecting){let i=e.target.dataset.src?e.target:e.target.querySelector("[data-src]");i.namespaceURI.includes("svg")?i.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i.dataset.src):i.setAttribute("src",i.dataset.src),i.classList.remove("lazy"),t.unobserve(i)}}))})),e.forEach((function(e){t.observe(e)}));else{var i;function n(){i&&clearTimeout(i),i=setTimeout((function(){var t=window.pageYOffset;e.forEach((function(e){e.offsetTop<window.innerHeight+t&&(e.src=e.dataset.src,e.classList.remove("lazy"))})),0==e.length&&(document.removeEventListener("scroll",n),window.removeEventListener("resize",n),window.removeEventListener("orientationChange",n))}),20)}e=document.querySelectorAll(".lazy"),document.addEventListener("scroll",n),window.addEventListener("resize",n),window.addEventListener("orientationChange",n)}},window.addImageToLoader=function(e){t.observe($("img",e).get(0))},window.WheelZoom=class{constructor({factor:e=.1,minScale:t=.2,maxScale:i=10,initialScale:n=1,disabled:s=!1}={}){this.factor=e,this.minScale=t,this.maxScale=i,this.initialScale=n,this.disabled=s,this.events=document.createElement("div"),this.events.classList.add("wheelzoom-events-js"),document.body.appendChild(this.events),this.targets=[],this.previousEvent=null,this.scale=this.initialScale,this.angle=0,this.pos={x:0,y:0}}register(e,{mirror:t=!1,map:i=!1}={}){this.events.addEventListener("wheelzoom.reset",this.reset.bind(this)),this.events.addEventListener("wheelzoom.refresh",this.refresh.bind(this));let n=new r(e,{map:i});if(n.update(this.pos,this.scale),this.targets.push(n),t)n.container.classList.add("mirror");else{function s(e){this.scrolling=n,this.scrolled.bind(this)(e)}function o(e){3!==e.which&&2!==e.button||(this.dragging=n,this.draggable.bind(this)(e))}n.container.addEventListener("mousewheel",s.bind(this)),n.container.addEventListener("DOMMouseScroll",s.bind(this)),n.container.addEventListener("mousedown",o.bind(this))}return n}zoomTo(e,t){var i=this.scale;this.scale*=Math.exp(t),null!==this.minScale&&(this.scale=Math.max(this.minScale,this.scale)),null!==this.maxScale&&(this.scale=Math.min(this.maxScale,this.scale));var n={scale:this.scale/i};this.pos.x-=Math.round((e.x-e.x/n.scale)*n.scale),this.pos.y-=Math.round((e.y-e.y/n.scale)*n.scale),this.updateStyle(n);for(let e of this.targets)e.showMap(this.pos,this.scale);return n}zoomIn(){var e=this.targets[0].element.getBoundingClientRect(),t={x:e.width/2-this.pos.x,y:e.height/2-this.pos.y};this.zoomTo(t,.1)}zoomOut(){var e=this.targets[0].element.getBoundingClientRect(),t={x:e.width/2-this.pos.x,y:e.height/2-this.pos.y};this.zoomTo(t,-.1)}scrolled(e){if(this.disabled)return null;e.preventDefault();var t=e.delta||e.wheelDelta;void 0===t&&(t=-e.detail),t=Math.max(-1,Math.min(1,t));let i=e.target.getBoundingClientRect();var n={x:e.pageX-i.x-document.documentElement.scrollLeft,y:e.pageY-i.y-document.documentElement.scrollTop};return this.zoomTo(n,t*this.factor)}drag(e){if(this.disabled)return null;e.preventDefault();var t=this.dragging;if(!t)return null;var i=t.container.getBoundingClientRect(),n=t.element.getBoundingClientRect(),s=this.pos.x,r=this.pos.y,o=this.angle;this.previousEvent&&(e.altKey?this.angle=(this.angle+(e.pageX-this.previousEvent.pageX))%360:(this.pos.x+=e.pageX-this.previousEvent.pageX,this.pos.y+=e.pageY-this.previousEvent.pageY)),n.width*this.scale>i.width?(this.pos.x>0&&(this.pos.x=0),this.pos.x+n.width<i.width&&(this.pos.x=i.width-n.width)):(this.pos.x<0&&(this.pos.x=0),this.pos.x+n.width>i.width&&(this.pos.x=i.width-n.width)),n.height*this.scale>i.height?(this.pos.y>0&&(this.pos.y=0),this.pos.y+n.height<i.height&&(this.pos.y=i.height-n.height)):(this.pos.y<0&&(this.pos.y=0),this.pos.y+n.height>i.height&&(this.pos.y=i.height-n.height)),this.previousEvent=e;let a={x:(this.pos.x-s)/this.scale,y:(this.pos.y-r)/this.scale,angle:this.angle-o};return this.updateStyle(a),this.dragging.showMap(this.pos,this.scale),a}removeDrag(){document.removeEventListener("mouseup",this.bRemDrag),document.removeEventListener("mousemove",this.bDrag),this.previousEvent=null}draggable(e){this.disabled||(e.preventDefault(),this.previousEvent=e,this.bDrag=this.drag.bind(this),this.bRemDrag=this.removeDrag.bind(this),document.addEventListener("mousemove",this.bDrag),document.addEventListener("mouseup",this.bRemDrag))}updateStyle(e){this.targets.forEach(function(e,t){e.update(this.pos,this.scale)}.bind(this));var t=new CustomEvent("wheelzoom.updated",{detail:{delta:e,pos:this.pos,scale:this.scale}});this.events&&this.events.dispatchEvent(t)}refresh(){this.updateStyle()}reset(){var e=this.pos.x,t=this.pos.y,i=this.angle;this.pos={x:0,y:0},this.scale=this.initialScale||1,this.updateStyle({x:-e,y:-t,scale:1/i})}disable(){this.disabled=!0}enable(){this.disabled=!1}destroy(){}},window.userProfile=l,window.setupFormSet=function(e){e.querySelectorAll(".js-formset-delete").forEach((e=>e.addEventListener("mouseup",(function(e){var t=e.target,i=document.getElementById(t.attributes.for.value);"on"==i.value?(t.classList.add("btn-outline-secondary"),t.classList.remove("btn-danger"),i.value=""):(t.classList.add("btn-danger"),t.classList.remove("btn-outline-secondary"),i.value="on")}))));for(var t=document.getElementsByClassName("js-formset-delete"),i=0;i<t.length;i++){var n=t.item(i);"on"==document.getElementById(n.attributes.for.value).value&&(n.classList.add("btn-danger"),n.classList.remove("btn-outline-secondary"))}e.addEventListener("change",(function(t){let i=t.target,n=i.closest(".js-formset-row");if(null===n)return;let s=n.parentNode.querySelectorAll(":scope > .js-formset-row");if(n==s[s.length-1]&&t.target.value){let t=i.id.split("-").splice(0,i.id.split("-").length-2).join("-").substr(3),s=e.querySelector("#id_"+t+"-TOTAL_FORMS"),r=parseInt(s.value);s.value=r+1;let o=n.cloneNode(!0);n.parentNode.appendChild(o),o.querySelectorAll("input,select").forEach((e=>{e.id=e.id.replace(/-\d+-(\D+$)/,"-"+r+"-$1"),e.name=e.name.replace(/-\d+-(\D+$)/,"-"+r+"-$1"),"hidden"!=e.type&&(e.value=""),"SELECT"==e.nodeName&&(e.querySelectorAll("option")[0].selected=!0)}))}}))},window.bootDocumentForm=function(e){setupFormSet(document.getElementById("document-form"));var t=window.location.hash;t&&$('div.nav.nav-tabs a[href="'+t+'"]').tab("show"),$("div.nav.nav-tabs a").click((function(e){$(this).is(".disabled")||($(this).tab("show"),$("body").scrollTop(),window.location.hash=this.hash)})),$("#id_main_script").on("change",(function(t){"horizontal-rl"==e[t.target.value]?"rtl"!==$("#id_read_direction").val()&&$("#id_read_direction").val("rtl").addClass("is-valid").removeClass("is-valid",1e3):"ltr"!==$("#id_read_direction").val()&&$("#id_read_direction").val("ltr").addClass("is-valid").removeClass("is-valid",1e3)}))},window.bootOntologyForm=function(){function e(e,t){return fetch("/api/types/"+e+"/",{method:"post",credentials:"same-origin",headers:{"X-CSRFToken":Cookies.get("csrftoken"),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({name:t})})}var t=!1;function i(e,i,n){let s=document.querySelectorAll(e+" .form-check"),r=s[s.length-1],o=r.cloneNode(!0),a=o.querySelector("input");a.value=i,a.checked=!0,o.querySelector("label").textContent=n,r.after(o),window.addEventListener("beforeunload",(function(e){if(!t){var i="It looks like you have unsaved Types. If you leave before saving, your changes will be lost.";return(e||window.event).returnValue=i,i}}))}document.querySelector("#ontology-form").addEventListener("submit",(e=>t=!0)),document.getElementById("add-region-type-btn").addEventListener("click",(function(t){t.preventDefault();let n=document.getElementById("add-region-type-input");n.value&&e("block",n.value).then((e=>e.json())).then((function(e){i("#region-types",e.pk,e.name),n.value=""}))})),document.getElementById("add-line-type-btn").addEventListener("click",(function(t){t.preventDefault();let n=document.getElementById("add-line-type-input");n.value&&e("line",n.value).then((e=>e.json())).then((function(e){i("#line-types",e.pk,e.name),n.value=""}))})),document.getElementById("add-part-type-btn").addEventListener("click",(function(t){t.preventDefault();let n=document.getElementById("add-part-type-input");n.value&&e("part",n.value).then((e=>e.json())).then((function(e){i("#part-types",e.pk,e.name),n.value=""}))})),setupFormSet(document.getElementById("ontology-form"))},window.bootImageCards=function(e,t,i,n){a={document:"/api/documents/"+(o=e),parts:"/api/documents/"+o+"/parts/",part:"/api/documents/"+o+"/parts/{part_pk}/"},$("#cards-container").on("dragover",".js-drop",(function(e){var t=$("#cards-container .js-drop").index(e.target),i=e.originalEvent.dataTransfer.getData("text/card-id");i||null==c||(i=c);var n=$("#cards-container .card").index(document.getElementById(i));-1!=e.originalEvent.dataTransfer.types.indexOf("text/card-id")&&t!=n&&t!=n+1&&($(e.target).addClass("drop-accept"),e.preventDefault())})),$("#cards-container").on("dragleave",".js-drop",(function(e){e.preventDefault(),$(e.target).removeClass("drop-accept")})),$("#cards-container").on("drop",".js-drop",(function(e){e.preventDefault(),$(e.target).removeClass("drop-accept");var t=e.originalEvent.dataTransfer.getData("text/card-id");t||(t=c);var i=document.getElementById(t),n=$(i).data("partCard"),s=$("#cards-container .js-drop").index(e.target);n.moveTo(s),c=null}));var s=["pending","ongoing","error","done"];function r(e,t){(!t.task_id||e.task_ids[t.process]==t.task_id)&&s.indexOf(e.workflow[t.process])>s.indexOf(t.status)||(e.workflow[t.process]=t.status,t.task_id&&(e.task_ids[t.process]=t.task_id),e.updateWorkflowIcons(),"generate_part_thumbnails"==t.process&&"done"==t.status&&(e.image.thumbnails=t.data,e.updateThumbnail()))}$("#alerts-container").on("part:workflow",(function(e,t){var i=u.fromPk(t.id);i?r(i,t):setTimeout((function(){$("#alerts-container").trigger(e,t)}),100)})),$("#alerts-container").on("parts:workflow",(function(e,t){for(var i=0;i<t.parts.length;i++){var n=u.fromPk(t.parts[i].id);n&&r(n,t.parts[i])}})),$("#alerts-container").on("part:new",(function(e,t){var n=u.fromPk(t.id),s=a.part.replace("{part_pk}",t.id);$.get(s,(function(e){n?(n.image.thumbnails||(n.image.thumbnails={}),n.image.thumbnails.card=e.image.thumbnails.card,n.updateThumbnail(),n.domElement.scrollIntoView(!1)):(new u(e,i),u.refreshSelectedCount())}))})),$("#alerts-container").on("part:delete",(function(e,t){var i=u.fromPk(t.id);i&&i.remove()}));let l=$("#alerts-container");l.on("import:start",(function(e,t){$("#import-counter").parent().addClass("ongoing"),$("#import-selected").addClass("blink"),$("#import-resume").hide()})),l.on("import:progress",(function(e,t){$("#import-counter").parent().addClass("ongoing"),$("#import-selected").addClass("blink"),$("#cancel-import").show(),t.progress&&$("#import-counter").text(t.progress+"/"+t.total)})),l.on("import:warning",(function(e,t){Alert.add(Date.now(),t.reason,"warning")})),l.on("import:error",(function(e,t){$("#import-counter").text("Failed."),$("#import-selected").removeClass("blink"),$("#cancel-import").hide(),t.reason&&Alert.add("import-failed","Import failed because '"+t.reason+"'","danger")})),l.on("import:done",(function(e,t){$("#import-counter").text("Done."),$("#import-counter").parent().removeClass("ongoing"),$("#import-selected").removeClass("blink"),$("#cancel-import").hide()})),$("#cancel-import").click((function(e,t){let i=a.document+"/cancel_import/";$.post(i,{}).done((function(e){$("#import-counter").text("canceled"),$("#import-counter").parent().removeClass("ongoing"),$("#import-selected").removeClass("blink")})).fail((function(e){console.log("Couldn't cancel import")}))}));var d=$("#document-export");l.on("export:start",(function(e,t){d.addClass("blink")})),l.on("export:error",(function(e,t){d.removeClass("blink"),d.addClass("error"),t.reason&&Alert.add("export-failed","Export failed because '"+t.reason+"'","danger")})),l.on("export:done",(function(e,t){d.removeClass("blink")})),$("#process-part-form-export #id_file_format").on("change",(function(e){let t=e.target;"text"==$(t).val()?($("#process-part-form-export #include_images").prop("checked",!1),$("#process-part-form-export #include_images").prop("disabled",!0)):$("#process-part-form-export #include_images").prop("disabled",!1)})),l.on("training:start",(function(e,t){$("#train-selected").addClass("blink"),$("#cancel-training").show()})),l.on("training:gathering",(function(e,t){$("#train-selected").addClass("blink"),$("#cancel-training").show()})),l.on("training:eval",(function(e,t){$("#train-selected").addClass("blink"),$("#cancel-training").show()})),l.on("training:done",(function(e,t){$("#train-selected").removeClass("blink"),$("#cancel-training").hide()})),l.on("training:error",(function(e,t){$("#train-selected").removeClass("blink").addClass("btn-danger"),$("#cancel-training").hide(),t.reason&&Alert.add("training-failed","Training failed because '"+t.reason+"'","danger")})),$("#cancel-training").click((function(e,t){let i=a.document+"/cancel_training/";$.post(i,{}).done((function(e){$("#train-selected").removeClass("blink"),$("#cancel-training").hide()})).fail((function(e){console.log("Couldn't cancel training")}))}));var p=new Dropzone(".dropzone",{paramName:"image",timeout:0,parallelUploads:1,error:(e,t)=>{if(e.previewElement){e.previewElement.classList.add("dz-error"),"string"!=typeof t&&t.image&&(t=t.image.toString());for(let i of e.previewElement.querySelectorAll("[data-dz-errormessage]"))i.textContent=t}}});p.on("success",(function(e,t){if(p.files.length>7)for(var i=0;i<p.files.length-7;i++)"success"==p.files[i].status&&p.removeFile(p.files[i])})),"False"===t&&p.disable(),$("#select-all").click((function(e){u.getRange(0,$("#cards-container .card").length).each((function(e,t){$(t).data("partCard").select(!1)})),u.refreshSelectedCount()})),$("#unselect-all").click((function(e){u.getRange(0,$("#cards-container .card").length).each((function(e,t){$(t).data("partCard").unselect()})),u.refreshSelectedCount()})),$(".js-proc-selected").click((function(e){h($(e.target).data("proc"))})),$("#process-part-form-binarize #id_threshold").on("input",(function(){$(this).attr("title",this.value)})),$("#process-part-form-transcribe #id_model").on("change",(function(e){var t=e.target.options[e.target.selectedIndex].innerHTML,i=document.querySelectorAll("#process-part-form-transcribe #id_transcription option"),n=Array.from(i).find((e=>e.innerHTML=="kraken:"+t));n&&(n.selected=!0)})),$("#process-part-form-export").submit((function(e){var t=$("#process-part-form-export #id_file_format").val();userProfile.set("exportFormat",t)})),$(".process-part-form").submit((function(e){e.preventDefault();var t=$(e.target),i=$(".js-submit-proc",t),n=t.data("proc");i.prop("disabled",!0);var s=$('<i class="fas fa-spinner fa-spin ml-2">');i.append(s);let r=new FormData(t.get(0));r.set("document",o),u.getSelectedPks().forEach((e=>r.append("parts",e))),$("div.field-error",t).remove(),$.ajax({url:t.attr("action"),type:t.attr("method"),data:r,processData:!1,contentType:!1}).done((function(e){DEBUG&&console.log(n+" process",e.status),"import-xml"==n||"import-iiif"==n?$("#import-counter").text("Queued.").show().parent().addClass("ongoing"):"train"==n&&$("#train-selected").addClass("blink").removeClass("btn-danger"),i.prop("disabled",!1),s.remove(),$("#"+n+"-wizard").modal("hide")})).fail((function(e){var t=e.responseJSON;if("error"==t.status){var r=JSON.parse(t.error);$("#"+n+"-wizard #wizard-form-error").text(r.__all__);for(let e in r){let t=$("#"+n+"-wizard #id_"+e),i=$('<div class="error field-error">');i.text(r[e]),t.parent().append(i)}}i.prop("disabled",!1),s.remove(),DEBUG&&console.log(e)}))}));var m=new URL(window.location).searchParams.get("select"),g=0,f=function(e){var t=a.parts+"?paginate_by=50&page="+e;$.get(t,(function(t){g+=t.results.length,$("#loading-counter").html(g+"/"+t.count);for(var s=0;s<t.results.length;s++){var r=new u(t.results[s],i,n);m==r.pk&&r.select()}t.next?f(e+1):($("#loading-counter").parent().hide(),u.refreshSelectedCount())}))};f(1)},window.bootModels=function(){let e=$("#alerts-container"),t={};$("#models-table tr.model-head").each((function(e,i){t[$(i).data("id")]=$("td#accuracy-"+$(i).data("id"),i).data("value")})),e.on("training:start",(function(e,t){let i=$("tr#tr-"+t.id);$(".training-ongoing",i).show(),$(".training-done",i).hide(),$(".training-error",i).hide(),$(".cancel-training",i).show()})),e.on("training:gathering",(function(e,t){let i=$("tr#tr-"+t.id);$(".training-ongoing",i).show(),$(".training-done",i).hide(),$(".training-error",i).hide(),$(".training-gathering",i).css("display","flex"),$(".training-gathering .progress-bar",i).css("width",Math.round(t.index/t.total*100)+"%"),$(".cancel-training",i).show()})),e.on("training:eval",(function(e,i){let n=$("tr#tr-"+i.id);$(".training-ongoing",n).show(),$(".training-done",n).hide(),$(".training-error",n).hide(),$(".training-gathering",n).hide(),t[i.id]<i.accuracy&&(n.data("value",i.accuracy),$("td#accuracy-"+i.id,n).text(Math.round(100*i.accuracy*100)/100+"%"),t[i.id]=i.accuracy),$(".cancel-training",n).show()})),e.on("training:done",(function(e,t){let i=$("tr#tr-"+t.id);$(".training-ongoing",i).hide(),$(".training-done",i).show(),$(".training-gathering",i).hide(),$(".cancel-training",i).hide()})),e.on("training:error",(function(e,t){let i=$("tr#tr-"+t.id);$(".training-ongoing",i).hide(),$(".training-done",i).hide(),$(".training-error",i).show(),$(".cancel-training",i).hide()}))},window.bootAlignForm=function(){const e=document.getElementById("process-part-form-align"),t=e.querySelector("#id_beam_size"),i=e.querySelector("#id_max_offset");t.addEventListener("input",(e=>{e.currentTarget.value&&""!==e.currentTarget.value&&"0"!==e.currentTarget.value?(i.setAttribute("disabled","true"),i.setAttribute("value",""),i.value=""):i.removeAttribute("disabled")})),i.addEventListener("input",(e=>{e.currentTarget.value&&""!==e.currentTarget.value&&"0"!==e.currentTarget.value?(t.setAttribute("disabled","true"),t.setAttribute("value",""),t.value=""):t.removeAttribute("disabled")}));const n=()=>{i.removeAttribute("disabled"),t.removeAttribute("disabled")};e.querySelector('button[data-dismiss="modal"]').addEventListener("click",n),e.querySelector('button[type="submit"]').addEventListener("click",n)}})()})();